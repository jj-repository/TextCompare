<!DOCTYPE html>
<!--
    TextCompare - Text Diff Tool

    A web-based text comparison tool that highlights differences between two text files.

    Features:
    - Side-by-side diff view with color-coded changes
    - Line-level and character-level difference highlighting
    - Navigation between differences with keyboard shortcuts
    - File loading and saving capabilities
    - Minimap for quick navigation
    - Customizable comparison options (ignore whitespace, ignore case)

    Browser Requirements:
    - Modern browsers with ES6 support (Chrome 51+, Firefox 54+, Safari 10+, Edge 15+)
    - FileReader API and CSS Flexbox support required

    Limitations:
    - Recommended file size limit: 10MB
    - Large files may cause browser performance issues
    - All processing is done client-side (no server uploads)
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; connect-src 'none'; frame-src 'none';">
    <title>TextCompare - Text Diff Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header / Toolbar */
        .toolbar {
            background: #2d2d2d;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #404040;
            flex-wrap: wrap;
        }

        .toolbar h1 {
            font-size: 1.2rem;
            color: #569cd6;
            margin-right: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #0e639c;
            color: white;
        }

        .btn-primary:hover {
            background: #1177bb;
        }

        .btn-secondary {
            background: #3c3c3c;
            color: #d4d4d4;
        }

        .btn-secondary:hover {
            background: #4c4c4c;
        }

        .btn-success {
            background: #388a34;
            color: white;
        }

        .btn-success:hover {
            background: #45a540;
        }

        .btn-danger {
            background: #c42b1c;
            color: white;
        }

        .btn-danger:hover {
            background: #e03e2f;
        }

        .btn-nav {
            background: #4d4d4d;
            color: #d4d4d4;
            padding: 8px 12px;
        }

        .btn-nav:hover {
            background: #5a5a5a;
        }

        .btn-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Focus styles for keyboard navigation */
        .btn:focus-visible {
            outline: 2px solid #569cd6;
            outline-offset: 2px;
        }

        .text-input:focus-visible {
            outline: 2px solid #569cd6;
            outline-offset: -2px;
        }

        .checkbox-label input:focus-visible {
            outline: 2px solid #569cd6;
            outline-offset: 2px;
        }

        .minimap-marker:focus-visible {
            outline: 2px solid #569cd6;
            outline-offset: 1px;
        }

        .separator {
            width: 1px;
            height: 30px;
            background: #404040;
            margin: 0 10px;
        }

        .diff-counter {
            background: #3c3c3c;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #9cdcfe;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #404040;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel-header {
            background: #252526;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #404040;
        }

        .panel-title {
            font-size: 0.9rem;
            color: #9cdcfe;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filename {
            color: #ce9178;
            font-style: italic;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 4px 10px;
            font-size: 0.8rem;
        }

        .editor-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .line-numbers {
            background: #1e1e1e;
            color: #858585;
            padding: 10px 8px;
            text-align: right;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            user-select: none;
            overflow: hidden;
            width: 50px;
            flex-shrink: 0;
            border-right: 1px solid #404040;
        }

        .line-numbers.hidden {
            display: none;
        }

        .text-input {
            flex: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }

        .text-input::placeholder {
            color: #6a6a6a;
        }

        .diff-view {
            flex: 1;
            background: #1e1e1e;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .diff-line {
            min-height: 21px;
            padding: 0 4px;
            border-radius: 2px;
        }

        .diff-line.added {
            background: rgba(35, 134, 54, 0.2);
        }

        .diff-line.removed {
            background: rgba(218, 54, 51, 0.2);
        }

        .diff-line.modified {
            background: rgba(227, 180, 72, 0.15);
        }

        .diff-line.current {
            outline: 2px solid #569cd6;
        }

        .diff-char-changed {
            background: rgba(218, 54, 51, 0.5);
            color: #ff6b6b;
            text-decoration: underline;
            text-decoration-color: #ff4444;
            text-decoration-thickness: 2px;
        }

        /* Thumbnail / Mini-map */
        .minimap {
            width: 30px;
            background: #252526;
            border-left: 1px solid #404040;
            position: relative;
            cursor: pointer;
        }

        .minimap-marker {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
        }

        .minimap-marker.added {
            background: #238636;
        }

        .minimap-marker.removed {
            background: #da3633;
        }

        .minimap-marker.modified {
            background: #e3b448;
        }

        /* Status Bar */
        .status-bar {
            background: #007acc;
            color: white;
            padding: 4px 15px;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
        }

        /* Hidden file input */
        .hidden {
            display: none;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            border: 1px solid #404040;
        }

        .modal h2 {
            margin-bottom: 15px;
            color: #569cd6;
        }

        .modal p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            margin-left: auto;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 2px;
        }

        .legend-color.added {
            background: rgba(35, 134, 54, 0.6);
        }

        .legend-color.removed {
            background: rgba(218, 54, 51, 0.6);
        }

        .legend-color.changed {
            background: rgba(218, 54, 51, 0.8);
        }

        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            background: #2d2d2d;
            padding: 30px 40px;
            border-radius: 8px;
            border: 1px solid #404040;
            text-align: center;
        }

        .spinner {
            border: 4px solid #404040;
            border-top: 4px solid #569cd6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }

        /* Options panel */
        .options-panel {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .checkbox-label input {
            cursor: pointer;
        }

        /* Mobile and touch improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Increase button padding for touch devices */
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
                min-height: 44px;
            }

            .btn-small {
                padding: 8px 14px;
                font-size: 0.9rem;
                min-height: 40px;
            }

            .btn-nav {
                padding: 12px 16px;
                min-height: 44px;
            }

            /* Larger checkboxes for touch */
            .checkbox-label input {
                width: 18px;
                height: 18px;
            }

            /* Adjust toolbar for mobile */
            .toolbar {
                padding: 12px 15px;
            }
        }

        /* Responsive layout for small screens */
        @media (max-width: 768px) {
            .toolbar {
                gap: 8px;
            }

            .toolbar h1 {
                font-size: 1rem;
                margin-right: 10px;
            }

            .legend {
                display: none;
            }

            .options-panel {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .separator {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <h1>TextCompare</h1>

        <button class="btn btn-success" onclick="compare()" title="Compare texts (Ctrl+Enter)">
            <span>Compare</span>
        </button>

        <div class="separator"></div>

        <button class="btn btn-nav" onclick="prevDiff()" id="btnPrev" disabled title="Previous difference (Ctrl+Up)" aria-label="Previous difference">
            <span>Prev</span>
        </button>
        <span class="diff-counter" id="diffCounter" role="status" aria-label="Difference counter">0 / 0</span>
        <button class="btn btn-nav" onclick="nextDiff()" id="btnNext" disabled title="Next difference (Ctrl+Down)" aria-label="Next difference">
            <span>Next</span>
        </button>

        <div class="separator"></div>

        <div class="options-panel">
            <label class="checkbox-label">
                <input type="checkbox" id="ignoreWhitespace">
                Ignore whitespace
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="ignoreCase">
                Ignore case
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="showLineNumbers" checked>
                Line numbers
            </label>
        </div>

        <div class="separator"></div>

        <button class="btn btn-secondary" onclick="swapPanels()" title="Swap left and right">
            <span>Swap</span>
        </button>

        <button class="btn btn-danger" onclick="clearAll()" title="Clear all">
            <span>Clear All</span>
        </button>

        <button class="btn btn-secondary" onclick="showHelp()" title="Help">
            <span>?</span>
        </button>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color added"></div>
                <span>Added</span>
            </div>
            <div class="legend-item">
                <div class="legend-color removed"></div>
                <span>Removed</span>
            </div>
            <div class="legend-item">
                <span style="color: #ff6b6b; text-decoration: underline red 2px;">Changed</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- Left Panel -->
        <div class="panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">
                    <span>Left (Original)</span>
                    <span class="filename" id="leftFilename">No file loaded</span>
                </div>
                <div class="panel-actions">
                    <button class="btn btn-primary btn-small" onclick="loadFile('left')">Load</button>
                    <button class="btn btn-success btn-small" onclick="saveFile('left')" title="Save file (Ctrl+Shift+S)">Save</button>
                    <button class="btn btn-secondary btn-small" onclick="clearPanel('left')">Clear</button>
                </div>
            </div>
            <div class="editor-container">
                <div class="line-numbers" id="leftLineNumbers" aria-hidden="true">1</div>
                <textarea class="text-input" id="leftText" placeholder="Paste or load text here..." aria-label="Left text input (original)"></textarea>
                <div class="diff-view hidden" id="leftDiff" role="region" aria-label="Left diff view"></div>
                <div class="minimap" id="leftMinimap" aria-label="Difference minimap"></div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="panel" id="rightPanel">
            <div class="panel-header">
                <div class="panel-title">
                    <span>Right (Modified)</span>
                    <span class="filename" id="rightFilename">No file loaded</span>
                </div>
                <div class="panel-actions">
                    <button class="btn btn-primary btn-small" onclick="loadFile('right')">Load</button>
                    <button class="btn btn-success btn-small" onclick="saveFile('right')" title="Save file (Ctrl+S)">Save</button>
                    <button class="btn btn-secondary btn-small" onclick="clearPanel('right')">Clear</button>
                </div>
            </div>
            <div class="editor-container">
                <div class="line-numbers" id="rightLineNumbers" aria-hidden="true">1</div>
                <textarea class="text-input" id="rightText" placeholder="Paste or load text here..." aria-label="Right text input (modified)"></textarea>
                <div class="diff-view hidden" id="rightDiff" role="region" aria-label="Right diff view"></div>
                <div class="minimap" id="rightMinimap" aria-label="Difference minimap"></div>
            </div>
        </div>
    </div>

    <div class="status-bar" role="status" aria-live="polite">
        <span id="statusLeft">Left: 0 lines, 0 characters</span>
        <span id="statusCenter">Ready</span>
        <span id="statusRight">Right: 0 lines, 0 characters</span>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="leftFileInput" class="hidden" accept=".txt,.md,.json,.xml,.html,.css,.js,.py,.java,.c,.cpp,.h,.csv,.log,.ini,.cfg,.yaml,.yml,*">
    <input type="file" id="rightFileInput" class="hidden" accept=".txt,.md,.json,.xml,.html,.css,.js,.py,.java,.c,.cpp,.h,.csv,.log,.ini,.cfg,.yaml,.yml,*">

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div>Comparing files...</div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
        <div class="modal">
            <h2 id="helpModalTitle">TextCompare - Help</h2>
            <p><strong>How to use:</strong></p>
            <p>1. Load or paste text into both panels</p>
            <p>2. Click "Compare" to see differences</p>
            <p>3. Use Prev/Next to navigate between changes</p>
            <p><strong>Keyboard shortcuts:</strong></p>
            <p>- <kbd>Ctrl+Enter</kbd> - Compare</p>
            <p>- <kbd>Ctrl+Up</kbd> - Previous difference</p>
            <p>- <kbd>Ctrl+Down</kbd> - Next difference</p>
            <p>- <kbd>Ctrl+S</kbd> - Save right file</p>
            <p>- <kbd>Ctrl+Shift+S</kbd> - Save left file</p>
            <p><strong>Color coding:</strong></p>
            <p>- <span style="color: #7ee787;">Green</span> - Added lines/text</p>
            <p>- <span style="color: #ff7b72;">Red</span> - Removed lines/text</p>
            <p>- <span style="color: #ff6b6b; text-decoration: underline red;">Red underline</span> - Changed characters</p>
            <p><strong>Limitations:</strong></p>
            <p>- Recommended file size limit: 10MB</p>
            <p>- Large files may cause browser slowdown</p>
            <p>- Files are processed client-side (nothing uploaded to server)</p>
            <p><strong>Browser compatibility:</strong></p>
            <p>- Modern browsers with ES6 support (Chrome 51+, Firefox 54+, Safari 10+, Edge 15+)</p>
            <p>- Requires FileReader API and CSS Flexbox support</p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeHelp()">Got it!</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';

            // Constants
            const BYTES_PER_MB = 1024 * 1024;
            const MAX_FILE_SIZE_MB = 10;
            const MAX_FILE_SIZE = MAX_FILE_SIZE_MB * BYTES_PER_MB;
            const LOADING_DELAY_MS = 10; // Delay before heavy computation to allow UI update
            const SCROLL_DEBOUNCE_MS = 16; // ~60fps for smooth scroll sync

            // Utility functions
            function debounce(fn, delay) {
                let timeoutId;
                return function(...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => fn.apply(this, args), delay);
                };
            }

            // State
            let differences = [];
            let currentDiffIndex = -1;
            let isCompareMode = false;
            let previouslyFocusedElement = null;

            // DOM Elements
            const leftText = document.getElementById('leftText');
            const rightText = document.getElementById('rightText');
            const leftDiff = document.getElementById('leftDiff');
            const rightDiff = document.getElementById('rightDiff');
            const leftLineNumbers = document.getElementById('leftLineNumbers');
            const rightLineNumbers = document.getElementById('rightLineNumbers');
            const leftFileInput = document.getElementById('leftFileInput');
            const rightFileInput = document.getElementById('rightFileInput');
            const diffCounter = document.getElementById('diffCounter');
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const statusCenter = document.getElementById('statusCenter');
            const statusLeft = document.getElementById('statusLeft');
            const statusRight = document.getElementById('statusRight');
            const leftFilename = document.getElementById('leftFilename');
            const rightFilename = document.getElementById('rightFilename');
            const leftMinimap = document.getElementById('leftMinimap');
            const rightMinimap = document.getElementById('rightMinimap');
            const helpModal = document.getElementById('helpModal');
            const ignoreWhitespaceCheckbox = document.getElementById('ignoreWhitespace');
            const ignoreCaseCheckbox = document.getElementById('ignoreCase');
            const showLineNumbersCheckbox = document.getElementById('showLineNumbers');

            // Initialize
            function init() {
                // Update line numbers on input
                leftText.addEventListener('input', () => {
                    updateLineNumbers('left');
                    updateStatus();
                    if (isCompareMode) exitCompareMode();
                });
                rightText.addEventListener('input', () => {
                    updateLineNumbers('right');
                    updateStatus();
                    if (isCompareMode) exitCompareMode();
                });

                // Sync scroll (debounced for performance)
                const debouncedSyncScroll = debounce(syncScroll, SCROLL_DEBOUNCE_MS);
                const debouncedSyncScrollDiff = debounce(syncScrollDiff, SCROLL_DEBOUNCE_MS);
                leftText.addEventListener('scroll', () => debouncedSyncScroll('left'));
                rightText.addEventListener('scroll', () => debouncedSyncScroll('right'));
                leftDiff.addEventListener('scroll', () => debouncedSyncScrollDiff('left'));
                rightDiff.addEventListener('scroll', () => debouncedSyncScrollDiff('right'));

                // File input handlers
                leftFileInput.addEventListener('change', (e) => handleFileLoad(e, 'left'));
                rightFileInput.addEventListener('change', (e) => handleFileLoad(e, 'right'));

                // Keyboard shortcuts
                document.addEventListener('keydown', handleKeyboard);

                // Line numbers toggle
                showLineNumbersCheckbox.addEventListener('change', toggleLineNumbers);

                updateStatus();
            }

            // Toggle line numbers visibility
            function toggleLineNumbers() {
                const show = showLineNumbersCheckbox.checked;
                leftLineNumbers.classList.toggle('hidden', !show);
                rightLineNumbers.classList.toggle('hidden', !show);
            }

            // Line numbers
            function updateLineNumbers(side) {
                const text = side === 'left' ? leftText : rightText;
                const lineNums = side === 'left' ? leftLineNumbers : rightLineNumbers;
                const lines = text.value.split('\n').length;
                lineNums.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('\n');
            }

            // Scroll sync
            function syncScroll(source) {
                if (isCompareMode) return;
                const sourceEl = source === 'left' ? leftText : rightText;
                const targetEl = source === 'left' ? rightText : leftText;
                const sourceLines = source === 'left' ? leftLineNumbers : rightLineNumbers;
                const targetLines = source === 'left' ? rightLineNumbers : leftLineNumbers;

                targetEl.scrollTop = sourceEl.scrollTop;
                sourceLines.scrollTop = sourceEl.scrollTop;
                targetLines.scrollTop = sourceEl.scrollTop;
            }

            function syncScrollDiff(source) {
                if (!isCompareMode) return;
                const sourceEl = source === 'left' ? leftDiff : rightDiff;
                const targetEl = source === 'left' ? rightDiff : leftDiff;
                const sourceLines = source === 'left' ? leftLineNumbers : rightLineNumbers;
                const targetLines = source === 'left' ? rightLineNumbers : leftLineNumbers;

                targetEl.scrollTop = sourceEl.scrollTop;
                sourceLines.scrollTop = sourceEl.scrollTop;
                targetLines.scrollTop = sourceEl.scrollTop;
            }

            // File loading
            function loadFile(side) {
                const input = side === 'left' ? leftFileInput : rightFileInput;
                input.click();
            }

            function handleFileLoad(event, side) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file size
                if (file.size > MAX_FILE_SIZE) {
                    const sizeMB = (file.size / BYTES_PER_MB).toFixed(2);
                    const maxSizeMB = MAX_FILE_SIZE_MB;
                    const proceed = confirm(
                        `Warning: File size is ${sizeMB}MB, which exceeds the recommended limit of ${maxSizeMB}MB.\n\n` +
                        `Large files may cause the browser to freeze during comparison.\n\n` +
                        `Do you want to continue?`
                    );
                    if (!proceed) {
                        event.target.value = '';
                        return;
                    }
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    if (side === 'left') {
                        leftText.value = text;
                        leftFilename.textContent = file.name;
                    } else {
                        rightText.value = text;
                        rightFilename.textContent = file.name;
                    }
                    updateLineNumbers(side);
                    updateStatus();
                    if (isCompareMode) exitCompareMode();
                    statusCenter.textContent = `Loaded: ${file.name}`;
                };
                reader.onerror = (e) => {
                    const errorMsg = `Failed to load file: ${file.name}`;
                    alert(errorMsg + '\n\nThe file may be corrupted or have an unsupported encoding.');
                    statusCenter.textContent = errorMsg;
                    console.error('FileReader error:', e);
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            // Save file
            function saveFile(side) {
                const text = side === 'left' ? leftText.value : rightText.value;
                const filenameEl = side === 'left' ? leftFilename : rightFilename;
                let filename = filenameEl.textContent;

                // Generate default filename if none loaded
                if (filename === 'No file loaded' || !filename) {
                    filename = side === 'left' ? 'left_text.txt' : 'right_text.txt';
                }

                // Prompt for filename
                const newFilename = prompt('Save as:', filename);
                if (!newFilename) return; // User cancelled

                // Create blob and download
                const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = newFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Update filename display
                filenameEl.textContent = newFilename;
                statusCenter.textContent = `Saved: ${newFilename}`;
            }

            // Clear functions
            function clearPanel(side) {
                if (side === 'left') {
                    leftText.value = '';
                    leftFilename.textContent = 'No file loaded';
                } else {
                    rightText.value = '';
                    rightFilename.textContent = 'No file loaded';
                }
                updateLineNumbers(side);
                updateStatus();
                if (isCompareMode) exitCompareMode();
            }

            function clearAll() {
                clearPanel('left');
                clearPanel('right');
            }

            // Swap panels
            function swapPanels() {
                const tempText = leftText.value;
                const tempFilenameText = leftFilename.textContent;

                leftText.value = rightText.value;
                leftFilename.textContent = rightFilename.textContent;

                rightText.value = tempText;
                rightFilename.textContent = tempFilenameText;

                updateLineNumbers('left');
                updateLineNumbers('right');
                updateStatus();
                if (isCompareMode) compare();
            }

            // Status bar
            function updateStatus() {
                const leftLines = leftText.value ? leftText.value.split('\n').length : 0;
                const leftChars = leftText.value.length;
                const rightLines = rightText.value ? rightText.value.split('\n').length : 0;
                const rightChars = rightText.value.length;

                statusLeft.textContent = `Left: ${leftLines} lines, ${leftChars} characters`;
                statusRight.textContent = `Right: ${rightLines} lines, ${rightChars} characters`;
            }

            // LCS-based diff algorithm with space optimization
            // Uses O(min(m,n)) space instead of O(m*n) for large inputs
            const LCS_FULL_MATRIX_THRESHOLD = 1000; // Use full matrix for small inputs

            function computeLCSOptimized(a, b) {
                const m = a.length, n = b.length;

                // For small inputs, use full matrix (simpler backtracking)
                if (m * n <= LCS_FULL_MATRIX_THRESHOLD * LCS_FULL_MATRIX_THRESHOLD) {
                    return computeLCSFullMatrix(a, b);
                }

                // For large inputs, use space-optimized version
                return computeLCSSpaceOptimized(a, b);
            }

            function computeLCSFullMatrix(a, b) {
                const m = a.length, n = b.length;
                const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

                for (let i = 1; i <= m; i++) {
                    for (let j = 1; j <= n; j++) {
                        if (a[i - 1] === b[j - 1]) {
                            dp[i][j] = dp[i - 1][j - 1] + 1;
                        } else {
                            dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                        }
                    }
                }
                return { type: 'full', dp, m, n };
            }

            function computeLCSSpaceOptimized(a, b) {
                const m = a.length, n = b.length;

                // Use two rows instead of full matrix
                let prev = new Array(n + 1).fill(0);
                let curr = new Array(n + 1).fill(0);

                // Store decisions for backtracking (bit-packed for memory efficiency)
                // 0 = came from left, 1 = came from top, 2 = diagonal match
                const decisions = new Array(m);

                for (let i = 1; i <= m; i++) {
                    decisions[i - 1] = new Uint8Array(n);
                    for (let j = 1; j <= n; j++) {
                        if (a[i - 1] === b[j - 1]) {
                            curr[j] = prev[j - 1] + 1;
                            decisions[i - 1][j - 1] = 2; // diagonal
                        } else if (prev[j] > curr[j - 1]) {
                            curr[j] = prev[j];
                            decisions[i - 1][j - 1] = 1; // top
                        } else {
                            curr[j] = curr[j - 1];
                            decisions[i - 1][j - 1] = 0; // left
                        }
                    }
                    [prev, curr] = [curr, prev];
                }

                return { type: 'optimized', decisions, m, n };
            }

            function backtrackLCS(lcsResult, a, b) {
                const result = [];
                let i = lcsResult.m, j = lcsResult.n;

                if (lcsResult.type === 'full') {
                    const dp = lcsResult.dp;
                    while (i > 0 && j > 0) {
                        if (a[i - 1] === b[j - 1]) {
                            result.unshift({ type: 'equal', left: i - 1, right: j - 1 });
                            i--; j--;
                        } else if (dp[i - 1][j] > dp[i][j - 1]) {
                            i--;
                        } else {
                            j--;
                        }
                    }
                } else {
                    const decisions = lcsResult.decisions;
                    while (i > 0 && j > 0) {
                        const decision = decisions[i - 1][j - 1];
                        if (decision === 2) { // diagonal match
                            result.unshift({ type: 'equal', left: i - 1, right: j - 1 });
                            i--; j--;
                        } else if (decision === 1) { // top
                            i--;
                        } else { // left
                            j--;
                        }
                    }
                }

                return result;
            }

            function diffLines(leftLines, rightLines) {
                const ignoreWhitespace = ignoreWhitespaceCheckbox.checked;
                const ignoreCase = ignoreCaseCheckbox.checked;

                const processLine = (line) => {
                    let processed = line;
                    if (ignoreWhitespace) processed = processed.replace(/\s+/g, ' ').trim();
                    if (ignoreCase) processed = processed.toLowerCase();
                    return processed;
                };

                const leftProcessed = leftLines.map(processLine);
                const rightProcessed = rightLines.map(processLine);

                const lcsResult = computeLCSOptimized(leftProcessed, rightProcessed);
                const lcs = backtrackLCS(lcsResult, leftProcessed, rightProcessed);

                const result = [];
                let li = 0, ri = 0, lcsIdx = 0;

                while (li < leftLines.length || ri < rightLines.length) {
                    if (lcsIdx < lcs.length && li === lcs[lcsIdx].left && ri === lcs[lcsIdx].right) {
                        // Check if lines are actually equal (considering original case/whitespace)
                        if (leftLines[li] === rightLines[ri]) {
                            result.push({ type: 'equal', leftLine: li, rightLine: ri, left: leftLines[li], right: rightLines[ri] });
                        } else {
                            result.push({ type: 'modified', leftLine: li, rightLine: ri, left: leftLines[li], right: rightLines[ri] });
                        }
                        li++; ri++; lcsIdx++;
                    } else if (lcsIdx < lcs.length && li < lcs[lcsIdx].left && ri < lcs[lcsIdx].right) {
                        // Both have content before next match - could be modifications
                        result.push({ type: 'modified', leftLine: li, rightLine: ri, left: leftLines[li], right: rightLines[ri] });
                        li++; ri++;
                    } else if (li < leftLines.length && (lcsIdx >= lcs.length || li < lcs[lcsIdx].left)) {
                        result.push({ type: 'removed', leftLine: li, left: leftLines[li] });
                        li++;
                    } else if (ri < rightLines.length && (lcsIdx >= lcs.length || ri < lcs[lcsIdx].right)) {
                        result.push({ type: 'added', rightLine: ri, right: rightLines[ri] });
                        ri++;
                    }
                }

                return result;
            }

            function diffChars(left, right) {
                if (!left || !right) return { left: left || '', right: right || '' };

                const leftChars = left.split('');
                const rightChars = right.split('');
                const lcsResult = computeLCSOptimized(leftChars, rightChars);
                const lcs = backtrackLCS(lcsResult, leftChars, rightChars);

                let leftHtml = '', rightHtml = '';
                let li = 0, ri = 0, lcsIdx = 0;

                while (li < left.length || ri < right.length) {
                    if (lcsIdx < lcs.length && li === lcs[lcsIdx].left && ri === lcs[lcsIdx].right) {
                        leftHtml += escapeHtml(left[li]);
                        rightHtml += escapeHtml(right[ri]);
                        li++; ri++; lcsIdx++;
                    } else {
                        let leftChunk = '', rightChunk = '';
                        while (li < left.length && (lcsIdx >= lcs.length || li < lcs[lcsIdx].left)) {
                            leftChunk += left[li++];
                        }
                        while (ri < right.length && (lcsIdx >= lcs.length || ri < lcs[lcsIdx].right)) {
                            rightChunk += right[ri++];
                        }
                        if (leftChunk) {
                            leftHtml += `<span class="diff-char-changed">${escapeHtml(leftChunk)}</span>`;
                        }
                        if (rightChunk) {
                            rightHtml += `<span class="diff-char-changed">${escapeHtml(rightChunk)}</span>`;
                        }
                    }
                }

                return { left: leftHtml, right: rightHtml };
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Main compare function
            function compare() {
                // Show loading overlay
                loadingOverlay.classList.add('active');

                // Use setTimeout to allow UI to update before heavy computation
                setTimeout(() => {
                    try {
                        const leftLines = leftText.value.split('\n');
                        const rightLines = rightText.value.split('\n');

                        const diff = diffLines(leftLines, rightLines);
                        differences = [];
                        currentDiffIndex = -1;

                        // Use arrays for efficient string building
                        const leftHtmlParts = [];
                        const rightHtmlParts = [];
                        const leftLineNumParts = [];
                        const rightLineNumParts = [];
                        let leftLineNum = 0, rightLineNum = 0;

                        diff.forEach((d) => {
                            let diffIdx = -1;

                            if (d.type === 'equal') {
                                leftLineNum++;
                                rightLineNum++;
                                leftHtmlParts.push(`<div class="diff-line">${escapeHtml(d.left) || '&nbsp;'}</div>`);
                                rightHtmlParts.push(`<div class="diff-line">${escapeHtml(d.right) || '&nbsp;'}</div>`);
                                leftLineNumParts.push(leftLineNum);
                                rightLineNumParts.push(rightLineNum);
                            } else if (d.type === 'modified') {
                                leftLineNum++;
                                rightLineNum++;
                                diffIdx = differences.length;
                                differences.push({ leftLine: leftLineNum, rightLine: rightLineNum, type: 'modified' });

                                const charDiff = diffChars(d.left, d.right);
                                leftHtmlParts.push(`<div class="diff-line modified" data-diff="${diffIdx}">${charDiff.left || '&nbsp;'}</div>`);
                                rightHtmlParts.push(`<div class="diff-line modified" data-diff="${diffIdx}">${charDiff.right || '&nbsp;'}</div>`);
                                leftLineNumParts.push(leftLineNum);
                                rightLineNumParts.push(rightLineNum);
                            } else if (d.type === 'removed') {
                                leftLineNum++;
                                diffIdx = differences.length;
                                differences.push({ leftLine: leftLineNum, type: 'removed' });

                                leftHtmlParts.push(`<div class="diff-line removed" data-diff="${diffIdx}">${escapeHtml(d.left) || '&nbsp;'}</div>`);
                                rightHtmlParts.push(`<div class="diff-line removed" data-diff="${diffIdx}">&nbsp;</div>`);
                                leftLineNumParts.push(leftLineNum);
                                rightLineNumParts.push('-');
                            } else if (d.type === 'added') {
                                rightLineNum++;
                                diffIdx = differences.length;
                                differences.push({ rightLine: rightLineNum, type: 'added' });

                                leftHtmlParts.push(`<div class="diff-line added" data-diff="${diffIdx}">&nbsp;</div>`);
                                rightHtmlParts.push(`<div class="diff-line added" data-diff="${diffIdx}">${escapeHtml(d.right) || '&nbsp;'}</div>`);
                                leftLineNumParts.push('-');
                                rightLineNumParts.push(rightLineNum);
                            }
                        });

                        // Update UI with joined arrays
                        leftDiff.innerHTML = leftHtmlParts.join('');
                        rightDiff.innerHTML = rightHtmlParts.join('');
                        leftLineNumbers.innerHTML = leftLineNumParts.join('\n');
                        rightLineNumbers.innerHTML = rightLineNumParts.join('\n');

                        // Show diff views
                        leftText.classList.add('hidden');
                        rightText.classList.add('hidden');
                        leftDiff.classList.remove('hidden');
                        rightDiff.classList.remove('hidden');

                        isCompareMode = true;
                        updateDiffCounter();
                        updateMinimap();

                        statusCenter.textContent = `Found ${differences.length} difference${differences.length !== 1 ? 's' : ''}`;

                        // Navigate to first diff if exists
                        if (differences.length > 0) {
                            currentDiffIndex = 0;
                            highlightCurrentDiff();
                        }
                    } catch (error) {
                        console.error('Error during comparison:', error);
                        alert('An error occurred during comparison. The files may be too large or contain invalid content.');
                        statusCenter.textContent = 'Comparison failed';
                    } finally {
                        // Hide loading overlay
                        loadingOverlay.classList.remove('active');
                    }
                }, LOADING_DELAY_MS);
            }

            function exitCompareMode() {
                isCompareMode = false;
                leftText.classList.remove('hidden');
                rightText.classList.remove('hidden');
                leftDiff.classList.add('hidden');
                rightDiff.classList.add('hidden');

                updateLineNumbers('left');
                updateLineNumbers('right');

                differences = [];
                currentDiffIndex = -1;
                updateDiffCounter();
                clearMinimap();

                statusCenter.textContent = 'Ready';
            }

            // Navigation
            function updateDiffCounter() {
                const current = currentDiffIndex >= 0 ? currentDiffIndex + 1 : 0;
                diffCounter.textContent = `${current} / ${differences.length}`;
                btnPrev.disabled = differences.length === 0 || currentDiffIndex <= 0;
                btnNext.disabled = differences.length === 0 || currentDiffIndex >= differences.length - 1;
            }

            function highlightCurrentDiff() {
                // Remove previous highlight
                document.querySelectorAll('.diff-line.current').forEach(el => el.classList.remove('current'));

                if (currentDiffIndex < 0 || currentDiffIndex >= differences.length) return;

                // Add highlight to current diff
                const diffLines = document.querySelectorAll(`[data-diff="${currentDiffIndex}"]`);
                diffLines.forEach(el => {
                    el.classList.add('current');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });

                updateDiffCounter();
            }

            function prevDiff() {
                if (currentDiffIndex > 0) {
                    currentDiffIndex--;
                    highlightCurrentDiff();
                }
            }

            function nextDiff() {
                if (currentDiffIndex < differences.length - 1) {
                    currentDiffIndex++;
                    highlightCurrentDiff();
                }
            }

            // Minimap
            function updateMinimap() {
                leftMinimap.innerHTML = '';
                rightMinimap.innerHTML = '';

                const totalLines = Math.max(
                    leftDiff.querySelectorAll('.diff-line').length,
                    rightDiff.querySelectorAll('.diff-line').length
                );

                if (totalLines === 0) return;

                differences.forEach((diff, idx) => {
                    const lineNum = diff.leftLine || diff.rightLine || 1;
                    const position = (lineNum / totalLines) * 100;

                    const createMarker = () => {
                        const marker = document.createElement('div');
                        marker.className = `minimap-marker ${diff.type}`;
                        marker.style.top = `${position}%`;
                        marker.onclick = () => {
                            currentDiffIndex = idx;
                            highlightCurrentDiff();
                        };
                        return marker;
                    };

                    leftMinimap.appendChild(createMarker());
                    rightMinimap.appendChild(createMarker());
                });
            }

            function clearMinimap() {
                leftMinimap.innerHTML = '';
                rightMinimap.innerHTML = '';
            }

            // Help modal with focus trap
            function showHelp() {
                previouslyFocusedElement = document.activeElement;
                helpModal.classList.add('active');
                // Focus the close button for accessibility
                const closeButton = helpModal.querySelector('.btn-primary');
                if (closeButton) {
                    closeButton.focus();
                }
            }

            function closeHelp() {
                helpModal.classList.remove('active');
                // Restore focus to the element that opened the modal
                if (previouslyFocusedElement && previouslyFocusedElement.focus) {
                    previouslyFocusedElement.focus();
                }
                previouslyFocusedElement = null;
            }

            // Focus trap for modal
            function handleModalKeydown(e) {
                if (!helpModal.classList.contains('active')) return;

                if (e.key === 'Tab') {
                    const focusableElements = helpModal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];

                    if (e.shiftKey && document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    } else if (!e.shiftKey && document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            }

            // Keyboard shortcuts
            function handleKeyboard(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    compare();
                } else if (e.ctrlKey && e.key === 'ArrowUp') {
                    e.preventDefault();
                    prevDiff();
                } else if (e.ctrlKey && e.key === 'ArrowDown') {
                    e.preventDefault();
                    nextDiff();
                } else if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 's') {
                    e.preventDefault();
                    saveFile('left');
                } else if (e.ctrlKey && !e.shiftKey && e.key.toLowerCase() === 's') {
                    e.preventDefault();
                    saveFile('right');
                } else if (e.key === 'Escape') {
                    closeHelp();
                    if (isCompareMode) exitCompareMode();
                }
            }

            // Close modal on overlay click
            helpModal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeHelp();
                }
            });

            // Focus trap for modal
            helpModal.addEventListener('keydown', handleModalKeydown);

            // Initialize on load
            init();

            // Expose functions to global scope for onclick handlers
            window.compare = compare;
            window.prevDiff = prevDiff;
            window.nextDiff = nextDiff;
            window.loadFile = loadFile;
            window.saveFile = saveFile;
            window.clearPanel = clearPanel;
            window.clearAll = clearAll;
            window.swapPanels = swapPanels;
            window.showHelp = showHelp;
            window.closeHelp = closeHelp;

        })();
    </script>
</body>
</html>
